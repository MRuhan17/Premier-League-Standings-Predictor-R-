# ==========================================
# 05_model_summary.R
# ==========================================
# Summarizes performance of trained models
# (Random Forest and XGBoost)
#
# Inputs:
#   - data/combined_features.csv
#   - models/rf_model.rds
#   - models/xgb_model.rds
#
# Output:
#   - models/model_summary.csv
# ==========================================

library(tidyverse)
library(data.table)
library(randomForest)
library(xgboost)
library(Metrics)

set.seed(42)

# -------------------------
# 1Ô∏è‚É£ Load data + models
# -------------------------
input_file <- "data/combined_features.csv"
if (!file.exists(input_file)) stop("‚ùå combined_features.csv not found!")

df <- fread(input_file)
df <- df %>%
  mutate(across(where(is.numeric), ~ ifelse(is.na(.x), 0, .x)))

target <- df$points
features <- df %>%
  select(avg_xG, avg_xGA, goals_for, goals_against, goal_diff, wins, draws, losses)
train_matrix <- as.matrix(features)

rf_path <- "models/rf_model.rds"
xgb_path <- "models/xgb_model.rds"

if (!file.exists(rf_path) | !file.exists(xgb_path))
  stop("‚ùå Missing saved model(s). Run 04_predict_and_report.R first!")

rf_model <- readRDS(rf_path)
xgb_model <- readRDS(xgb_path)

# -------------------------
# 2Ô∏è‚É£ Evaluation helper
# -------------------------
evaluate_model <- function(model, type, data, target) {
  start <- Sys.time()
  
  preds <- if (type == "rf") {
    predict(model, newdata = data)
  } else {
    predict(model, newdata = xgb.DMatrix(data))
  }
  
  end <- Sys.time()
  runtime <- round(as.numeric(difftime(end, start, units = "secs")), 2)
  
  rmse_val <- rmse(target, preds)
  mae_val <- mae(target, preds)
  r2_val <- 1 - sum((target - preds)^2) / sum((target - mean(target))^2)
  
  # Feature importances
  top_features <- tryCatch({
    if (type == "rf") {
      imp <- importance(model)
      top <- head(sort(imp[, 1], decreasing = TRUE), 3)
      paste(names(top), collapse = ", ")
    } else {
      imp <- xgb.importance(model = model)
      paste(head(imp$Feature, 3), collapse = ", ")
    }
  }, error = function(e) "N/A")
  
  params <- if (type == "rf") {
    paste0("ntree=", model$ntree, ", mtry=", model$mtry)
  } else {
    "max_depth=4, eta=0.1"
  }
  
  tibble(
    model_name = ifelse(type == "rf", "Random Forest", "XGBoost"),
    rmse = round(rmse_val, 3),
    mae = round(mae_val, 3),
    r_squared = round(r2_val, 3),
    training_time_sec = runtime,
    best_params = params,
    top_features = top_features
  )
}

# -------------------------
# 3Ô∏è‚É£ Evaluate both models
# -------------------------
rf_summary <- evaluate_model(rf_model, "rf", train_matrix, target)
xgb_summary <- evaluate_model(xgb_model, "xgb", train_matrix, target)
model_summary <- bind_rows(rf_summary, xgb_summary)

# -------------------------
# 4Ô∏è‚É£ Save summary CSV
# -------------------------
dir.create("models", showWarnings = FALSE)
fwrite(model_summary, "models/model_summary.csv")

message("üíæ Model summary saved -> models/model_summary.csv")
print(model_summary)

